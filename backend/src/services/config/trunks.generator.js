const fs = require('fs').promises;
const path = require('path');
const config = require('../../config/app');

class TrunksGenerator {
    constructor() {
        this.configPath = path.join(__dirname, '../../../', config.paths.generated);
    }

    // Безопасная запись файла
    async safeWriteFile(filename, content) {
        const tempPath = path.join(this.configPath, `${filename}.tmp`);
        const finalPath = path.join(this.configPath, filename);

        try {
            await fs.writeFile(tempPath, content, 'utf8');
            await fs.rename(tempPath, finalPath);
            console.log(`✅ Trunk config saved: ${filename}`);
        } catch (error) {
            try {
                await fs.unlink(tempPath);
            } catch (unlinkError) {}
            throw error;
        }
    }

    // Генерация PJSIP конфига для транка
    generatePJSIPTrunk(trunkConfig) {
        const {
            id,
            name,
            type = 'peer', // peer, user, friend
            host,
            port = 5060,
            username,
            password,
            fromuser,
            fromdomain,
            context = 'from-trunk',
            qualify = 'yes',
            qualify_frequency = 60,
            insecure = 'invite,port',
            encryption = 'no',
            protocol = 'udp',
            register = 'no'
        } = trunkConfig;

        let configContent = `
; Generated by AsteriskGUI - ${new Date().toISOString()}
; Trunk: ${name}

[${id}]
type=endpoint
context=${context}
disallow=all
allow=ulaw,alaw,g729,gsm
auth=${id}
outbound_auth=${id}
from_user=${fromuser || username}
rtp_symmetric=yes
force_rport=yes
rewrite_contact=yes
direct_media=no
`.trim();

        if (host) {
            configContent += `\nremote_hosts=${host}`;
            if (port && port !== 5060) {
                configContent += `:${port}`;
            }
        }

        configContent += `\nqualify=${qualify}`;
        if (qualify === 'yes') {
            configContent += `\nqualify_frequency=${qualify_frequency}`;
        }

        configContent += `\n\n[${id}]
type=auth
auth_type=userpass
password=${password}
username=${username}
\n`;

        configContent += `[${id}]
type=aor
max_contacts=1
qualify_frequency=0
\n`;

        if (register === 'yes' && host && username && password) {
            configContent += `[${id}]
type=registration
outbound_auth=${id}
server_uri=sip:${host}${port && port !== 5060 ? `:${port}` : ''}
client_uri=sip:${username}@${host}${port && port !== 5060 ? `:${port}` : ''}
transport=${protocol}
\n`;
        }

        // Identify для транка
        configContent += `[${id}-identify]
type=identify
endpoint=${id}
`;

        if (host) {
            configContent += `match=${host}\n`;
        }

        return configContent;
    }

    // Генерация SIP.conf конфига для транка (для совместимости)
    generateSIPTrunk(trunkConfig) {
        const {
            id,
            name,
            host,
            port = 5060,
            username,
            password,
            fromuser,
            fromdomain,
            context = 'from-trunk',
            qualify = 'yes',
            insecure = 'invite,port'
        } = trunkConfig;

        return `
; Generated by AsteriskGUI - ${new Date().toISOString()}
; Trunk: ${name}

[${id}]
type=peer
host=${host}
port=${port}
username=${username}
secret=${password}
fromuser=${fromuser || username}
fromdomain=${fromdomain || host}
context=${context}
qualify=${qualify}
insecure=${insecure}
canreinvite=no
dtmfmode=rfc2833
disallow=all
allow=ulaw,alaw,g729,gsm
`.trim();
    }

    // Генерация полного pjsip.conf с транками
    async generateFullPJSIPWithTrunks(sipAccounts = [], trunks = []) {
        let configContent = `; Generated by AsteriskGUI - ${new Date().toISOString()}\n`;
        configContent += `; DO NOT EDIT MANUALLY - Changes will be overwritten\n\n`;

        // Добавляем транспорт
        configContent += `[transport-udp]
type=transport
protocol=udp
bind=0.0.0.0

[transport-tcp]
type=transport
protocol=tcp
bind=0.0.0.0

\n`;

        // Добавляем SIP аккаунты
        for (const account of sipAccounts) {
            const pjsipGenerator = require('./pjsip.generator');
            configContent += pjsipGenerator.generateSIPAccount(account) + '\n\n';
        }

        // Добавляем транки
        for (const trunk of trunks) {
            configContent += this.generatePJSIPTrunk(trunk) + '\n\n';
        }

        return configContent;
    }

    // Сохранение полного pjsip.conf с транками
    async saveFullPJSIPConfig(sipAccounts = [], trunks = []) {
        const configContent = await this.generateFullPJSIPWithTrunks(sipAccounts, trunks);
        await this.safeWriteFile('pjsip.conf', configContent);
        return configContent;
    }

    // Сохранение отдельных транков как отдельных файлов
    async saveIndividualTrunkConfig(trunk) {
        const configContent = this.generatePJSIPTrunk(trunk);
        const filename = `pjsip_trunk_${trunk.id}.conf`;
        await this.safeWriteFile(filename, configContent);
        return configContent;
    }
}

module.exports = new TrunksGenerator();